# This file is sourced by lustre/lustrecvs

portalstag=""
lnettag="b1_x"
libsysiotag="HEAD"
snmptag="HEAD"
ldiskfstag="HEAD"
ldiskfstag_head="b1_8_iam"
lustreiokittag="HEAD"
libcfstag="b1_x"
dmutag=""
hg_base_url="http://www.wizy.org/mercurial"

export LC_COLLATE=C

case "$lustretag" in
    '')
        warn "a lustretag is required."
        usage >&2
        exit 1
        ;;
    --help | -h)
        usage
        exit 0
        ;;

    # this is the branch table
    # keep this list sorted alphabetically!

    # Note these are "specials" -- branches using lnet b1_x don't need an
    # entry here.

    b1_2)
        portalstag="b1_2"
        lnettag=""
        libsysiotag=""
        snmptag=""
        ;;

    b1_4_atime_update)
        portalstag="b_hd_newconfig"
        ;;

    b1_4_join)
        portalstag="b_hd_newconfig"
        ;;

    b1_4_lfs_df)
        portalstag="b_hd_newconfig"
        ;;

    b1_4_lov_lvb_cleanup)
        portalstag="b_hd_newconfig"
        ;;

    b1_4_next_recovery_transno)
        portalstag="b_hd_newconfig"
        ;;

    b_cmd_cray)
        lnettag="HEAD"
        ldiskfstag="$ldiskfstag_head"
        libcfstag="HEAD"
        ;;

    b_cmd*)
        portalstag="$lustretag"
        ;;

    b_iam*)
        portalstag="b_hd_newconfig"
        # XXX temorary tag until b_iam* is updated from b1_4 liblustre
        libsysiotag="HEAD_RELEASE_1_4_6_LAND_PARENT_20060223_1455"
        ;;

    b_ioprovement)
        portalstag="b_ioprovement"
        ;;

    b_mpilnd)
        # lnet mpilnd development branch
        lnettag="b_mpilnd"
        lustretag="HEAD"
        ;;

    b_new_cmd)
        portalstag="b_new_portals"
        # lnettag="b_lnet_tmp"
        ;;

    b_newconfig_rdmarouting)
        portalstag="b_hd_newconfig"
        lnettag="b_newconfig_rdmarouting"
        lustretag="b1_4"
        ;;

    b_port_ahead)
        portalstag="b_port_ahead"
        ;;

    b_port_netid)
        portalstag="b_port_netid"
        ;;

    # b_port_step is only for portals
    b_port_step)
        portalstag="b_port_step"
        lustretag="HEAD"
        ;;

    b_port_test)
        portalstag="b_port_test"
        ;;

    b_ptlrpc_cleanup)
        portalstag="b_ptlrpc_cleanup"
        ;;

    b_ptl_smallfix)
        portalstag="b_ptl_smallfix"
        lustretag="b1_4"
        ;;

    # before 1_4_6, we didn't have lnet or snmp
    b_release_1_2_*|b_release_1_4_[0-5])
        portalstag="$lustretag"
        lnettag=""
        libsysiotag="$lustretag"
        snmptag=""
        ;;

    b_release_1_4_6)
        portalstag="$lustretag"
        lnettag="$lustretag"
        libsysiotag="$lustretag"
        snmptag="$lustretag"
        ;;

    b_release_1_4_6-patchless)
        portalstag=b_release_1_4_6
        lnettag=b_release_1_4_6-patchless
        libsysiotag=b_release_1_4_6
        snmptag=b_release_1_4_6
        ;;

    # all later b_release_* tags
    b_release_*)
        lnettag="$lustretag"
        libsysiotag="$lustretag"
        snmptag="$lustretag"
        ldiskfstag="$lustretag"
        ;;

    b_self_test)
        # lnet self test development branch
        lnettag="b_self_test"
        lustretag="HEAD"
        ;;

    b_usocklnd)
        # lnet usocklnd development branch
        lnettag="b_usocklnd"
        lustretag="b1_6_usocklnd"
        ;;

    b_uo2iblnd)
        # lnet u-o2iblnd development branch
        lnettag="b_uo2iblnd"
        lustretag="HEAD"
        ;;

    b_hd_lnet_smp)
        # LNet grained locking and SMP improvement branch
        lnettag="b_hd_lnet_smp"
        ldiskfstag="lnet_smp_ldiskfs"
        lustretag="lnet_smp_lustre"
        libcfstag="lnet_smp_libcfs"
        ;;

    b_hd_lnet_perf)
        # Tag for lnet performance tests
        lnettag="lnet_smp_lnet"
        ldiskfstag="lnet_smp_ldiskfs"
        lustretag="lnet_smp_lustre"
        libcfstag="lnet_smp_libcfs"
        ;;

    b_hd_o2ib_new_proto)
        # LNet branch for new o2iblnd protocol (15983, 13621, 14425, 14358)
        lnettag="b_hd_o2ib_new_proto"
        ldiskfstag="$ldiskfstag_head"
        lustretag="HEAD"
        libcfstag="HEAD"
        ;;

    b_ula)
        # lnet "User Level Access" development branch
        lnettag="b_ula"
        lustretag="HEAD"
        ldiskfstag="$ldiskfstag_head"
        ;;

    # CMD3
    b_post_cmd3|b_new_cmd_sles10|b1_6_head_sync|b_mixed_layout_req|b_mount_perm|b1_8_gns|b1_8_interop_server)
        # Update b1_8 above when changing this.
        ldiskfstag="$ldiskfstag_head"
        ;;

    #umds cleanup
    b_hd_umds_cln2)
        ldiskfstag="b1_8_iam_dynlock"
        ;;

    # uOSS
    b_hd_dmu)
        lnettag="b_uoss"
        ldiskfstag="$ldiskfstag_head"
        dmutag="zfs-lustre"
        ;;

    # read-only cache for oss
    b_hd_rocache_oss)
        lnettag="HEAD"
        ldiskfstag="b1_8_iam"
        libcfstag="HEAD"
        ;;
 
    # vector read/write 
    b_hd_readx)
        lnettag="HEAD"
        ldiskfstag="$ldiskfstag_head"
        libcfstag="HEAD"
        ;;
   
    # params_tree 
    b_hd_params_tree)
        lnettag="b_hd_params_tree"
        ldiskfstag="$ldiskfstag_head"
        libcfstag="b_hd_params_tree"
        lustretag="b_hd_params_tree"
        ;;
  
    # Network request scheduler
    b_hd_nrs)
        lnettag="HEAD"
        ldiskfstag="$ldiskfstag_head"
        libcfstag="HEAD"
        ;;
 
    # uMDS
    b_dmu_umds)
        lnettag="b_uoss_umds"
        ldiskfstag="$ldiskfstag_head"
        dmutag="zfs-lustre"
        ;;

    # uOSS o2iblnd
    b_uoss_o2iblnd)
        lnettag="b_uoss_o2iblnd"
        lustretag="b_hd_dmu"
        ldiskfstag="$ldiskfstag_head"
        dmutag="zfs-lustre"
        ;;

    # client io stack cleanup
    b_client_io_layering)
        lnettag="HEAD"
        ldiskfstag="$ldiskfstag_head"
        libcfstag="HEAD"
        ;;
    
    # HEAD cmd fixes
    b_head_cmd)
        lnettag="HEAD"
        ldiskfstag="$ldiskfstag_head"
        libcfstag="HEAD"
        ;;
    
    # windows client porting (lustre: b_client_io_layering, lnet: HEAD) 
    b_winnt_port)
        ldiskfstag="$ldiskfstag_head"
        lnettag="b_winnt_port"
        libcfstag="b_winnt_port"
        ;;
    
    # v1.0-v1.3, v1.4.0-v1.4.2
    v1_[0-3]_*|v1_4_[0-2]|v1_4_[0-2]_*)
        portalstag="$lustretag"
        lnettag=""
        libsysiotag="$lustretag"
        snmptag=""
        ;;

    # v1.4.3-v1.4.5, v1.4.5.1 - v1.4.5.9
    v1_4_[3-5]|v1_4_[3-4]_*|v1_4_5_[1-9]|cray_2005*)
        portalstag="$lustretag"
        lnettag=""
        libsysiotag="$lustretag"
        snmptag="$lustretag"
        ;;

    # v1.4.6, v1.4.6.[1-91]
    v1_4_6_[1-9]|v1_4_6_9[01])
        portalstag="$lustretag"
        lnettag=""
        libsysiotag="$lustretag"
        snmptag="$lustretag"
        ;;

    # Interoperability server side changes
    b_head_interop_disk)
        lnettag="HEAD"
        ldiskfstag="b_ldiskfs_interop_server"
        libcfstag="HEAD"
        ;;

    # Branches that have been updated to include
    # the libcfs split should be added here
    HEAD|b_head_capa|b_hd_cfld|b_hd_changelog|b_hd_sptlrpc|HD_SPTLRPC_BASE|b_som|b_hd_kdmu|b_hd_recov|b_hd_transapi)
        lnettag="HEAD"
        ldiskfstag="$ldiskfstag_head"
        libcfstag="HEAD"
        ;;

    b_head_libcfs)
        lnettag="b_head_libcfs"
        ldiskfstag="$ldiskfstag_head"
        libcfstag="b_head_libcfs"
        ;;

    b_head_procfs)
        lnettag="HEAD"
        ldiskfstag="$ldiskfstag_head"
        libcfstag="b_head_procfs"
	;;

    b2_0-bld*)
        lnettag="$lustretag"
        ldiskfstag="$ldiskfstag_head"
        libcfstag="$lustretag"
	;;

    # all later v* tags
    v[1-9]*)
        lnettag="$lustretag"
        libsysiotag="$lustretag"
        snmptag="$lustretag"
        ldiskfstag="$lustretag"
        libcfstag="$lustretag"
        ;;

    b_HEAD_*|b_head_*|b_hd_*)
        lnettag="HEAD"
        ldiskfstag="$ldiskfstag_head"
        libcfstag="HEAD"
        ;;
esac

cvs_cmd libsysio libsysio "$libsysiotag"
cvs_cmd portals portals "$portalstag"
cvs_cmd lnet lnet "$lnettag"
cvs_cmd snmp lustre-snmp "$snmptag"
cvs_cmd lustre lustre-core "$lustretag"
cvs_cmd ldiskfs ldiskfs "$ldiskfstag"
cvs_cmd lustre-iokit lustre-iokit "$lustreiokittag"
hg_cmd lustre/zfs-lustre "$hg_base_url" "$dmutag"
cvs_cmd libcfs libcfs "$libcfstag"

[ -a ldiskfs/build ] || ln -sf ../build ldiskfs/build
