#!/bin/sh
#
# Script which does some basic tests to ensure we haven't regressed.
# Probably a good idea to run this before doing any checkins.
# In the future this can become more fancy, but it's OK for now.

SRCDIR="`dirname $0`"
fail() { 
	echo "ERROR: $1" 1>&2
	[ $2 ] && RC=$2 || RC=1
	exit $RC
}

export PATH=/sbin:/usr/sbin:$SRCDIR:$PATH

cleanup() {
        $LCONF --cleanup $OPTS
	trap 0
}

ERROR=
SRC=/etc
[ "$COUNT" ] || COUNT=1000

[ "$LCONF" ] || LCONF=$SRCDIR/../utils/lconf

OSCMT="`mount | awk '/ lustre_lite / { print $3 }' | tail -1`"
if [ -z "$OSCMT" ]; then
	[ -z "$*" ] && fail "usage: $0 [--reformat] <conf>.xml" 1
	$LCONF $@ || exit 1
        trap cleanup 0
	OSCMT="`mount | awk '/ lustre_lite / { print $3 }' | tail -1`"
	[ -z "$OSCMT" ] && fail "no lustre filesystem mounted" 1
fi

while [ "$1" ]; do
	case $1 in
	-v|--verbose) V=-v;;
	--reformat) : ;;
	*) OPTS="$OPTS $1" ;;
	esac
	shift
done

OSCTMP=`echo $OSCMT | tr "/" "."`
USED=`df | awk "/$OSCTMP/ { print \\$3 }" | tail -1`
USED=`expr $USED + 16`	# Some space for the status file

# let's start slowly here...
echo "touching $OSCMT"
touch $OSCMT || fail "can't touch $OSCMT" 2
HOSTS=$OSCMT/hosts.$$
echo "copying /etc/hosts to $HOSTS"
cp /etc/hosts $HOSTS || fail "can't cp /etc/hosts to $HOSTS" 3
echo "comparing /etc/hosts and $HOSTS"
diff -u /etc/hosts $HOSTS || fail "$HOSTS different" 4
echo "renaming $HOSTS to $HOSTS.ren"
mv $HOSTS $HOSTS.ren || fail "can't rename $HOSTS to $HOSTS.ren" 5
echo "copying /etc/hosts to $HOSTS again"
cp /etc/hosts $HOSTS || fail "can't cp /etc/hosts to $HOSTS again" 6
echo "truncating $HOSTS"
> $HOSTS || fail "can't truncate $HOSTS" 8
echo "removing $HOSTS"
rm $HOSTS || fail "can't remove $HOSTS" 9

DST=$OSCMT/runtest.$$
# let's start slowly here...
echo "creating $DST"
mkdir $DST || fail "can't mkdir $DST" 10

# ok, that hopefully worked, so let's do a little more
FILES=`find $SRC -type f | head -$COUNT`
echo "copying files from $SRC to $DST$SRC"
tar cf - $FILES | tar xvf - -C $DST || fail "copying $SRC" 11

echo "comparing newly copied files"
for f in $FILES; do
	[ $V ] && echo "verifying $DST/$f"
	diff -q $f $DST/$f || ERROR=11
done

[ "$ERROR" ] && fail "old and new files are different" $ERROR

$LCONF --cleanup $OPTS || exit 19
$LCONF $OPTS || exit 20

echo "comparing previously copied files"
for f in $FILES; do
	[ $V ] && echo "verifying $DST/$f"
	diff -q $f $DST/$f || ERROR=22
done

[ "$ERROR" ] && fail "old and new files are different on second diff" $ERROR

$LCONF --cleanup $OPTS || exit 29
$LCONF $OPTS || exit 30

echo "renaming $HOSTS.ren to $HOSTS"
mv $HOSTS.ren $HOSTS || fail "can't rename $HOSTS.ren to $HOSTS" 32
echo "truncating $HOSTS"
> $HOSTS || fail "can't truncate $HOSTS" 34
echo "removing $HOSTS"
rm $HOSTS || fail "can't remove $HOSTS again" 36
echo "removing $DST"
rm -r $V $DST || fail "can't remove $DST" 37

NOWUSED=`df | awk "/$OSCTMP/ { print \\$3 }" | tail -1`
if [ $NOWUSED -gt $USED ]; then
	echo "Space not all freed: now ${NOWUSED}kB, was ${USED}kB." 1>&2
	echo "This is normal on BA OSTs, because of subdirectories." 1>&2
fi

cleanup $OPTS || exit 29
