--- linux-2.4.20-vanilla/arch/i386/kernel/sys_i386.c~uml-2.4.20-do_mmap_pgoff-fix	2001-03-19 23:35:09.000000000 +0300
+++ linux-2.4.20-vanilla-alexey/arch/i386/kernel/sys_i386.c	2003-09-15 10:26:19.000000000 +0400
@@ -56,7 +56,7 @@ static inline long do_mmap2(
 	}
 
 	down_write(&current->mm->mmap_sem);
-	error = do_mmap_pgoff(file, addr, len, prot, flags, pgoff);
+	error = do_mmap_pgoff(current->mm, file, addr, len, prot, flags, pgoff);
 	up_write(&current->mm->mmap_sem);
 
 	if (file)
--- linux-2.4.24-vanilla/arch/x86_64/kernel/sys_x86_64.c	2004-10-15 12:19:54.919366416 -0400
+++ linux-2.4.24-vanilla-x86_64/arch/x86_64/kernel/sys_x86_64.c	2003-11-28 13:26:19.000000000 -0500
@@ -56,7 +56,7 @@
 	}
 
 	down_write(&current->mm->mmap_sem);
-	error = do_mmap_pgoff(file, addr, len, prot, flags, off >> PAGE_SHIFT);
+	error = do_mmap_pgoff(current->mm, file, addr, len, prot, flags, off >> PAGE_SHIFT);
 	up_write(&current->mm->mmap_sem);
 
 	if (file)
--- linux-2.4.24-vanilla/arch/x86_64/ia32/sys_ia32.c	2003-11-28 13:26:19.000000000 -0500
+++ linux-2.4.24-vanilla-x86_64/arch/x86_64/ia32/sys_ia32.c	2004-10-15 12:36:52.114075768 -0400
@@ -335,7 +335,7 @@
 
 	mm = current->mm; 
 	down_write(&mm->mmap_sem); 
-	retval = do_mmap_pgoff(file, a.addr, a.len, a.prot, a.flags, a.offset>>PAGE_SHIFT);
+	retval = do_mmap_pgoff(current->mm, file, a.addr, a.len, a.prot, a.flags, a.offset>>PAGE_SHIFT);
 	if (file)
 		fput(file);
 
@@ -2111,7 +2111,7 @@
 		prot |= PROT_EXEC;
 
 	down_write(&mm->mmap_sem);
-	error = do_mmap_pgoff(file, addr, len, prot, flags|MAP_32BIT, pgoff);
+	error = do_mmap_pgoff(current->mm, file, addr, len, prot, flags|MAP_32BIT, pgoff);
 	up_write(&mm->mmap_sem);
 
 	if (file)
