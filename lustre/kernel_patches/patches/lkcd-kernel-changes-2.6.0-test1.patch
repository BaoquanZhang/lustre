 arch/i386/Kconfig                           |   50 ++++++++++++++++++++++++++++
 arch/i386/boot/Makefile                     |    1 
 arch/i386/kernel/i386_ksyms.c               |   19 ++++++++++
 arch/i386/kernel/nmi.c                      |    2 +
 arch/i386/kernel/setup.c                    |    6 +++
 arch/i386/kernel/smp.c                      |   16 +++++++-
 arch/i386/kernel/traps.c                    |    2 +
 arch/i386/mm/init.c                         |    6 +++
 arch/s390/boot/Makefile                     |    2 -
 arch/s390/boot/install.sh                   |   24 +++++++++----
 drivers/Makefile                            |    1 
 include/asm-i386/kmap_types.h               |    5 +-
 include/asm-i386/mach-default/irq_vectors.h |    1 
 include/asm-i386/smp.h                      |    1 
 include/linux/major.h                       |    2 +
 init/Makefile                               |    4 ++
 init/main.c                                 |   10 +++++
 init/version.c                              |    4 ++
 kernel/ksyms.c                              |    8 ++++
 kernel/panic.c                              |   17 +++++++++
 kernel/sched.c                              |   22 ++++++++++++
 lib/Kconfig                                 |   10 +++--
 mm/page_alloc.c                             |    3 +
 scripts/mkcompile_h                         |    4 +-
 24 files changed, 202 insertions(+), 18 deletions(-)

--- linux-2.6.0-test1/drivers/Makefile~lkcd-kernel-changes-2.6.0-test1	2003-07-13 21:37:15.000000000 -0600
+++ linux-2.6.0-test1-braam/drivers/Makefile	2003-07-22 00:52:14.000000000 -0600
@@ -49,3 +49,4 @@ obj-$(CONFIG_ISDN_BOOL)		+= isdn/
 obj-$(CONFIG_MCA)		+= mca/
 obj-$(CONFIG_EISA)		+= eisa/
 obj-$(CONFIG_CPU_FREQ)		+= cpufreq/
+obj-$(CONFIG_CRASH_DUMP)	+= dump/
--- linux-2.6.0-test1/include/linux/major.h~lkcd-kernel-changes-2.6.0-test1	2003-07-13 21:31:58.000000000 -0600
+++ linux-2.6.0-test1-braam/include/linux/major.h	2003-07-22 00:52:14.000000000 -0600
@@ -157,6 +157,8 @@
 
 #define OSST_MAJOR		206	/* OnStream-SCx0 SCSI tape */
 
+#define CRASH_DUMP_MAJOR	221	/* crash dump interface */
+
 #define IBM_TTY3270_MAJOR	227
 #define IBM_FS3270_MAJOR	228
 
--- linux-2.6.0-test1/include/asm-i386/mach-default/irq_vectors.h~lkcd-kernel-changes-2.6.0-test1	2003-07-13 21:31:59.000000000 -0600
+++ linux-2.6.0-test1-braam/include/asm-i386/mach-default/irq_vectors.h	2003-07-22 00:52:14.000000000 -0600
@@ -48,6 +48,7 @@
 #define INVALIDATE_TLB_VECTOR	0xfd
 #define RESCHEDULE_VECTOR	0xfc
 #define CALL_FUNCTION_VECTOR	0xfb
+#define DUMP_VECTOR		0xfa
 
 #define THERMAL_APIC_VECTOR	0xf0
 /*
--- linux-2.6.0-test1/include/asm-i386/kmap_types.h~lkcd-kernel-changes-2.6.0-test1	2003-07-22 00:46:07.000000000 -0600
+++ linux-2.6.0-test1-braam/include/asm-i386/kmap_types.h	2003-07-22 00:53:23.000000000 -0600
@@ -1,4 +1,4 @@
-#ifndef _ASM_KMAP_TYPES_H
+22#ifndef _ASM_KMAP_TYPES_H
 #define _ASM_KMAP_TYPES_H
 
 #include <linux/config.h>
@@ -26,7 +26,8 @@ D(12)	KM_IRQ0,
 D(13)	KM_IRQ1,
 D(14)	KM_SOFTIRQ0,
 D(15)	KM_SOFTIRQ1,
-D(16)	KM_TYPE_NR
+D(16)	KM_DUMP
+D(17)	KM_TYPE_NR
 };
 
 #undef D
--- linux-2.6.0-test1/include/asm-i386/smp.h~lkcd-kernel-changes-2.6.0-test1	2003-07-22 00:46:07.000000000 -0600
+++ linux-2.6.0-test1-braam/include/asm-i386/smp.h	2003-07-22 00:52:14.000000000 -0600
@@ -38,6 +38,7 @@ extern int smp_num_siblings;
 extern int cpu_sibling_map[];
 
 extern void smp_flush_tlb(void);
+extern void dump_send_ipi(void);
 extern void smp_message_irq(int cpl, void *dev_id, struct pt_regs *regs);
 extern void smp_send_reschedule(int cpu);
 extern void smp_invalidate_rcv(void);		/* Process an NMI */
--- linux-2.6.0-test1/arch/i386/kernel/i386_ksyms.c~lkcd-kernel-changes-2.6.0-test1	2003-07-13 21:39:21.000000000 -0600
+++ linux-2.6.0-test1-braam/arch/i386/kernel/i386_ksyms.c	2003-07-22 00:52:14.000000000 -0600
@@ -16,6 +16,7 @@
 #include <linux/tty.h>
 #include <linux/highmem.h>
 #include <linux/time.h>
+#include <linux/nmi.h>
 
 #include <asm/semaphore.h>
 #include <asm/processor.h>
@@ -33,6 +34,7 @@
 #include <asm/tlbflush.h>
 #include <asm/nmi.h>
 #include <asm/edd.h>
+#include <asm/e820.h>
 
 extern void dump_thread(struct pt_regs *, struct user *);
 extern spinlock_t rtc_lock;
@@ -209,3 +211,20 @@ EXPORT_SYMBOL(kmap_atomic_to_page);
 EXPORT_SYMBOL(edd);
 EXPORT_SYMBOL(eddnr);
 #endif
+
+#ifdef CONFIG_CRASH_DUMP_MODULE
+#ifdef CONFIG_SMP
+extern irq_desc_t irq_desc[NR_IRQS];
+extern unsigned long irq_affinity[NR_IRQS];
+extern void stop_this_cpu(void *);
+EXPORT_SYMBOL(irq_desc);
+EXPORT_SYMBOL(irq_affinity);
+EXPORT_SYMBOL(stop_this_cpu);
+EXPORT_SYMBOL(dump_send_ipi);
+#endif
+extern int pfn_is_ram(unsigned long);
+EXPORT_SYMBOL(pfn_is_ram);
+#ifdef ARCH_HAS_NMI_WATCHDOG
+EXPORT_SYMBOL(touch_nmi_watchdog);
+#endif
+#endif
--- linux-2.6.0-test1/arch/i386/kernel/nmi.c~lkcd-kernel-changes-2.6.0-test1	2003-07-22 00:46:03.000000000 -0600
+++ linux-2.6.0-test1-braam/arch/i386/kernel/nmi.c	2003-07-22 00:52:14.000000000 -0600
@@ -24,6 +24,7 @@
 #include <linux/kernel_stat.h>
 #include <linux/module.h>
 #include <linux/nmi.h>
+#include <linux/dump.h>
 #include <linux/sysdev.h>
 
 #include <asm/smp.h>
@@ -449,6 +450,7 @@ void nmi_watchdog_tick (struct pt_regs *
 			bust_spinlocks(1);
 			printk("NMI Watchdog detected LOCKUP on CPU%d, eip %08lx, registers:\n", cpu, regs->eip);
 			show_registers(regs);
+			dump("NMI Watchdog detected LOCKUP", regs);
 			printk("console shuts up ...\n");
 			console_silent();
 			spin_unlock(&nmi_print_lock);
--- linux-2.6.0-test1/arch/i386/kernel/setup.c~lkcd-kernel-changes-2.6.0-test1	2003-07-22 00:46:03.000000000 -0600
+++ linux-2.6.0-test1-braam/arch/i386/kernel/setup.c	2003-07-22 00:52:14.000000000 -0600
@@ -439,6 +439,7 @@ static void __init setup_memory_region(v
 	print_memory_map(who);
 } /* setup_memory_region */
 
+unsigned long crashdump_addr = 0xdeadbeef;
 
 static void __init parse_cmdline_early (char ** cmdline_p)
 {
@@ -532,6 +533,9 @@ static void __init parse_cmdline_early (
 		if (c == ' ' && !memcmp(from, "highmem=", 8))
 			highmem_pages = memparse(from+8, &from) >> PAGE_SHIFT;
 	
+		if (c == ' ' && !memcmp(from, "crashdump=", 10))
+			crashdump_addr = memparse(from+10, &from); 
+			
 		c = *(from++);
 		if (!c)
 			break;
@@ -914,6 +918,8 @@ static int __init noreplacement_setup(ch
 
 __setup("noreplacement", noreplacement_setup); 
 
+extern void crashdump_reserve(void);
+
 void __init setup_arch(char **cmdline_p)
 {
 	unsigned long max_low_pfn;
--- linux-2.6.0-test1/arch/i386/kernel/smp.c~lkcd-kernel-changes-2.6.0-test1	2003-07-22 00:46:03.000000000 -0600
+++ linux-2.6.0-test1-braam/arch/i386/kernel/smp.c	2003-07-22 00:52:14.000000000 -0600
@@ -19,6 +19,7 @@
 #include <linux/mc146818rtc.h>
 #include <linux/cache.h>
 #include <linux/interrupt.h>
+#include <linux/dump.h>
 
 #include <asm/mtrr.h>
 #include <asm/pgalloc.h>
@@ -144,6 +145,13 @@ inline void __send_IPI_shortcut(unsigned
 	 */
 	cfg = __prepare_ICR(shortcut, vector);
 
+	if (vector == DUMP_VECTOR) {
+		/*
+		 * Setup DUMP IPI to be delivered as an NMI
+		 */
+		cfg = (cfg&~APIC_VECTOR_MASK)|APIC_DM_NMI;
+	}
+
 	/*
 	 * Send the IPI. The write to APIC_ICR fires this off.
 	 */
@@ -467,6 +475,11 @@ void flush_tlb_all(void)
 	on_each_cpu(do_flush_tlb_all, 0, 1, 1);
 }
 
+void dump_send_ipi(void)
+{
+	send_IPI_allbutself(DUMP_VECTOR);
+}
+
 /*
  * this function sends a 'reschedule' IPI to another CPU.
  * it goes straight through and wastes no time serializing
@@ -555,7 +568,7 @@ int smp_call_function (void (*func) (voi
 	return 0;
 }
 
-static void stop_this_cpu (void * dummy)
+void stop_this_cpu (void * dummy)
 {
 	/*
 	 * Remove this CPU:
@@ -616,4 +629,3 @@ asmlinkage void smp_call_function_interr
 		atomic_inc(&call_data->finished);
 	}
 }
-
--- linux-2.6.0-test1/arch/i386/kernel/traps.c~lkcd-kernel-changes-2.6.0-test1	2003-07-22 00:46:03.000000000 -0600
+++ linux-2.6.0-test1-braam/arch/i386/kernel/traps.c	2003-07-22 00:52:14.000000000 -0600
@@ -25,6 +25,7 @@
 #include <linux/highmem.h>
 #include <linux/kallsyms.h>
 #include <linux/ptrace.h>
+#include <linux/dump.h>
 
 #ifdef CONFIG_EISA
 #include <linux/ioport.h>
@@ -322,6 +323,7 @@ void die(const char * str, struct pt_reg
 #endif
  	CHK_REMOTE_DEBUG(0,SIGTRAP,err,regs,)
 	show_registers(regs);
+	dump((char *)str, regs);
 	bust_spinlocks(0);
 	spin_unlock_irq(&die_lock);
 	if (in_interrupt())
--- linux-2.6.0-test1/arch/i386/mm/init.c~lkcd-kernel-changes-2.6.0-test1	2003-07-22 00:46:03.000000000 -0600
+++ linux-2.6.0-test1-braam/arch/i386/mm/init.c	2003-07-22 00:52:14.000000000 -0600
@@ -186,6 +186,12 @@ static inline int page_is_ram(unsigned l
 	return 0;
 }
 
+/* To enable modules to check if a page is in RAM */
+int pfn_is_ram(unsigned long pfn)
+{
+	return (page_is_ram(pfn));
+}
+
 #ifdef CONFIG_HIGHMEM
 pte_t *kmap_pte;
 pgprot_t kmap_prot;
--- linux-2.6.0-test1/arch/i386/boot/Makefile~lkcd-kernel-changes-2.6.0-test1	2003-07-13 21:33:11.000000000 -0600
+++ linux-2.6.0-test1-braam/arch/i386/boot/Makefile	2003-07-22 00:52:14.000000000 -0600
@@ -101,3 +101,4 @@ zlilo: $(BOOTIMAGE)
 
 install: $(BOOTIMAGE)
 	sh $(src)/install.sh $(KERNELRELEASE) $(BOOTIMAGE) System.map "$(INSTALL_PATH)"
+	if [ -f init/kerntypes.o ]; then cp init/kerntypes.o $(INSTALL_PATH)/Kerntypes; fi
--- linux-2.6.0-test1/arch/i386/Kconfig~lkcd-kernel-changes-2.6.0-test1	2003-07-22 00:46:03.000000000 -0600
+++ linux-2.6.0-test1-braam/arch/i386/Kconfig	2003-07-22 00:52:14.000000000 -0600
@@ -1297,6 +1297,56 @@ source "arch/i386/oprofile/Kconfig"
 
 menu "Kernel hacking"
 
+config CRASH_DUMP
+	tristate "Crash dump support (EXPERIMENTAL)"
+	depends on EXPERIMENTAL
+	default n
+	---help---
+	  Say Y here to enable saving an image of system memory when a panic
+	  or other error occurs. Dumps can also be forced with the SysRq+d
+	  key if MAGIC_SYSRQ is enabled.
+
+config CRASH_DUMP_BLOCKDEV
+	tristate "Crash dump block device driver"
+	depends on CRASH_DUMP
+	help
+	  Say Y to allow saving crash dumps directly to a disk device.
+
+config CRASH_DUMP_NETDEV
+	tristate "Crash dump network device driver"
+	depends on CRASH_DUMP
+	help
+	  Say Y to allow saving crash dumps over a network device.
+
+config CRASH_DUMP_MEMDEV
+	bool "Crash dump staged memory driver"
+	depends on CRASH_DUMP
+	help
+	  Say Y to allow intermediate saving crash dumps in spare 
+	  memory pages which would then be written out to disk
+	  later.
+
+config CRASH_DUMP_SOFTBOOT
+	bool "Save crash dump across a soft reboot"
+	depends on CRASH_DUMP_MEMDEV
+	help
+	  Say Y to allow a crash dump to be preserved in memory
+	  pages across a soft reboot and written out to disk
+	  thereafter. For this to work, CRASH_DUMP must be 
+	  configured as part of the kernel (not as a module).
+
+config CRASH_DUMP_COMPRESS_RLE
+	tristate "Crash dump RLE compression"
+	depends on CRASH_DUMP
+	help
+	  Say Y to allow saving dumps with Run Length Encoding compression.
+
+config CRASH_DUMP_COMPRESS_GZIP
+	tristate "Crash dump GZIP compression"
+	depends on CRASH_DUMP
+	help
+	  Say Y to allow saving dumps with Gnu Zip compression.
+
 config DEBUG_KERNEL
 	bool "Kernel debugging"
 	help
--- linux-2.6.0-test1/arch/s390/boot/Makefile~lkcd-kernel-changes-2.6.0-test1	2003-07-13 21:39:33.000000000 -0600
+++ linux-2.6.0-test1-braam/arch/s390/boot/Makefile	2003-07-22 00:52:14.000000000 -0600
@@ -16,4 +16,4 @@ $(obj)/image: vmlinux FORCE
 
 install: $(CONFIGURE) $(obj)/image
 	sh -x $(obj)/install.sh $(KERNELRELEASE) $(obj)/image \
-	      System.map Kerntypes "$(INSTALL_PATH)"
+	      System.map init/kerntypes.o "$(INSTALL_PATH)"
--- linux-2.6.0-test1/arch/s390/boot/install.sh~lkcd-kernel-changes-2.6.0-test1	2003-07-13 21:35:17.000000000 -0600
+++ linux-2.6.0-test1-braam/arch/s390/boot/install.sh	2003-07-22 00:52:14.000000000 -0600
@@ -16,7 +16,8 @@
 #   $1 - kernel version
 #   $2 - kernel image file
 #   $3 - kernel map file
-#   $4 - default install path (blank if root directory)
+#   $4 - kernel type file
+#   $5 - default install path (blank if root directory)
 #
 
 # User may have a custom install script
@@ -26,13 +27,22 @@ if [ -x /sbin/installkernel ]; then exec
 
 # Default install - same as make zlilo
 
-if [ -f $4/vmlinuz ]; then
-	mv $4/vmlinuz $4/vmlinuz.old
+if [ -f $5/vmlinuz ]; then
+	mv $5/vmlinuz $5/vmlinuz.old
 fi
 
-if [ -f $4/System.map ]; then
-	mv $4/System.map $4/System.old
+if [ -f $5/System.map ]; then
+	mv $5/System.map $5/System.old
 fi
 
-cat $2 > $4/vmlinuz
-cp $3 $4/System.map
+if [ -f $5/Kerntypes ]; then
+	mv $5/Kerntypes $5/Kerntypes.old
+fi
+
+cat $2 > $5/vmlinuz
+cp $3 $5/System.map
+
+# copy the kernel type file if it exists
+if [ -f $4 ]; then
+	cp $4 $5/Kerntypes
+fi
--- linux-2.6.0-test1/scripts/mkcompile_h~lkcd-kernel-changes-2.6.0-test1	2003-07-13 21:39:36.000000000 -0600
+++ linux-2.6.0-test1-braam/scripts/mkcompile_h	2003-07-22 00:52:14.000000000 -0600
@@ -33,7 +33,7 @@ UTS_VERSION="$UTS_VERSION `LANG=C date`"
 
 UTS_LEN=64
 UTS_TRUNCATE="sed -e s/\(.\{1,$UTS_LEN\}\).*/\1/"
-
+LINUX_COMPILE_VERSION_ID="__linux_compile_version_id__`hostname | tr -c '[0-9A-Za-z\n]' '__'`_`LANG=C date | tr -c '[0-9A-Za-z\n]' '_'`"
 # Generate a temporary compile.h
 
 ( echo /\* This file is auto generated, version $VERSION \*/
@@ -55,6 +55,8 @@ UTS_TRUNCATE="sed -e s/\(.\{1,$UTS_LEN\}
   fi
 
   echo \#define LINUX_COMPILER \"`$CC -v 2>&1 | tail -1`\"
+  echo \#define LINUX_COMPILE_VERSION_ID $LINUX_COMPILE_VERSION_ID
+  echo \#define LINUX_COMPILE_VERSION_ID_TYPE typedef char* "$LINUX_COMPILE_VERSION_ID""_t"
 ) > .tmpcompile
 
 # Only replace the real compile.h if the new one is different,
--- linux-2.6.0-test1/kernel/ksyms.c~lkcd-kernel-changes-2.6.0-test1	2003-07-22 00:46:07.000000000 -0600
+++ linux-2.6.0-test1-braam/kernel/ksyms.c	2003-07-22 00:52:14.000000000 -0600
@@ -60,6 +60,8 @@
 #include <linux/backing-dev.h>
 #include <linux/percpu_counter.h>
 #include <asm/checksum.h>
+#include <linux/dump.h>
+#include <linux/bootmem.h>
 
 #if defined(CONFIG_PROC_FS)
 #include <linux/proc_fs.h>
@@ -627,3 +629,9 @@ EXPORT_SYMBOL(ptrace_notify);
 EXPORT_SYMBOL(console_printk);
 
 EXPORT_SYMBOL(current_kernel_time);
+
+#ifdef CONFIG_CRASH_DUMP_MODULE
+EXPORT_SYMBOL(min_low_pfn);
+EXPORT_SYMBOL(dump_oncpu);
+EXPORT_SYMBOL(dump_function_ptr);
+#endif
--- linux-2.6.0-test1/kernel/panic.c~lkcd-kernel-changes-2.6.0-test1	2003-07-13 21:38:38.000000000 -0600
+++ linux-2.6.0-test1-braam/kernel/panic.c	2003-07-22 00:52:14.000000000 -0600
@@ -16,12 +16,16 @@
 #include <linux/init.h>
 #include <linux/sysrq.h>
 #include <linux/interrupt.h>
+#ifdef CONFIG_KEXEC
+#include <linux/kexec.h>
+#endif
 
 asmlinkage void sys_sync(void);	/* it's really int */
 
 int panic_timeout;
 int panic_on_oops;
 int tainted;
+void (*dump_function_ptr)(const char *, const struct pt_regs *) = 0;
 
 struct notifier_block *panic_notifier_list;
 
@@ -54,6 +58,7 @@ NORET_TYPE void panic(const char * fmt, 
 	va_start(args, fmt);
 	vsnprintf(buf, sizeof(buf), fmt, args);
 	va_end(args);
+
 	printk(KERN_EMERG "Kernel panic: %s\n",buf);
 	if (in_interrupt())
 		printk(KERN_EMERG "In interrupt handler - not syncing\n");
@@ -76,6 +81,18 @@ NORET_TYPE void panic(const char * fmt, 
 		 * We can't use the "normal" timers since we just panicked..
 	 	 */
 		printk(KERN_EMERG "Rebooting in %d seconds..",panic_timeout);
+#ifdef CONFIG_KEXEC
+{
+		struct kimage *image;
+		image = xchg(&kexec_image, 0);
+		if (image) {
+			printk(KERN_EMERG "by starting a new kernel ..\n");
+			mdelay(panic_timeout*1000);
+			machine_kexec(image);
+		}
+}
+#endif
+
 		mdelay(panic_timeout*1000);
 		/*
 		 *	Should we run the reboot notifier. For the moment Im
--- linux-2.6.0-test1/kernel/sched.c~lkcd-kernel-changes-2.6.0-test1	2003-07-22 00:46:07.000000000 -0600
+++ linux-2.6.0-test1-braam/kernel/sched.c	2003-07-22 00:52:14.000000000 -0600
@@ -41,6 +41,9 @@
 #define cpu_to_node_mask(cpu) (cpu_online_map)
 #endif
 
+/* used to soft spin in sched while dump is in progress */
+int dump_oncpu;
+
 /*
  * Convert user-nice values [ -20 ... 0 ... 19 ]
  * to static priority [ MAX_RT_PRIO..MAX_PRIO-1 ],
@@ -1335,6 +1338,15 @@ asmlinkage void schedule(void)
 	struct list_head *queue;
 	int idx;
 
+ 	/*
+	 * If crash dump is in progress, this other cpu's
+	 * need to wait until it completes.
+	 * NB: this code is optimized away for kernels without
+	 * dumping enabled.
+	 */
+	if (unlikely(dump_oncpu))
+		goto dump_scheduling_disabled;
+
 	/*
 	 * Test if we are atomic.  Since do_exit() needs to call into
 	 * schedule() atomically, we ignore that path for now.
@@ -1422,6 +1434,16 @@ switch_tasks:
 	preempt_enable_no_resched();
 	if (test_thread_flag(TIF_NEED_RESCHED))
 		goto need_resched;
+
+	return;
+
+ dump_scheduling_disabled:
+	/* allow scheduling only if this is the dumping cpu */
+	if (dump_oncpu != smp_processor_id()+1) {
+		while (dump_oncpu)
+			cpu_relax();
+	}
+	return;
 }
 
 #ifdef CONFIG_PREEMPT
--- linux-2.6.0-test1/lib/Kconfig~lkcd-kernel-changes-2.6.0-test1	2003-07-13 21:34:43.000000000 -0600
+++ linux-2.6.0-test1-braam/lib/Kconfig	2003-07-22 00:52:14.000000000 -0600
@@ -17,14 +17,16 @@ config CRC32
 #
 config ZLIB_INFLATE
 	tristate
-	default y if CRAMFS=y || PPP_DEFLATE=y || JFFS2_FS=y || ZISOFS_FS=y || BINFMT_ZFLAT=y || CRYPTO_DEFLATE=y
-	default m if CRAMFS=m || PPP_DEFLATE=m || JFFS2_FS=m || ZISOFS_FS=m || BINFMT_ZFLAT=m || CRYPTO_DEFLATE=m
+	default y if CRAMFS=y || PPP_DEFLATE=y || JFFS2_FS=y || ZISOFS_FS=y || BINFMT_ZFLAT=y || CRYPTO_DEFLATE=y || CRASH_DUMP_COMPRESS_GZIP=y
+	default m if CRAMFS=m || PPP_DEFLATE=m || JFFS2_FS=m || ZISOFS_FS=m || BINFMT_ZFLAT=m || CRYPTO_DEFLATE=m || CRASH_DUMP_COMPRESS_GZIP=m
 
 config ZLIB_DEFLATE
 	tristate
 	default m if PPP_DEFLATE!=y && JFFS2_FS!=y && CRYPTO_DEFLATE!=y && \
-		(PPP_DEFLATE=m || JFFS2_FS=m || CRYPTO_DEFLATE=m)
-	default y if PPP_DEFLATE=y || JFFS2_FS=y || CRYPTO_DEFLATE=y
+		(PPP_DEFLATE=m || JFFS2_FS=m || CRYPTO_DEFLATE=m \
+			|| CRASH_DUMP_COMPRESS_GZIP=m )
+	default y if PPP_DEFLATE=y || JFFS2_FS=y || CRYPTO_DEFLATE=y \
+		|| CRASH_DUMP_COMPRESS_GZIP=y
 
 endmenu
 
--- linux-2.6.0-test1/mm/page_alloc.c~lkcd-kernel-changes-2.6.0-test1	2003-07-13 21:30:01.000000000 -0600
+++ linux-2.6.0-test1-braam/mm/page_alloc.c	2003-07-22 00:52:14.000000000 -0600
@@ -89,7 +89,8 @@ static void bad_page(const char *functio
 	page->mapping = NULL;
 }
 
-#ifndef CONFIG_HUGETLB_PAGE
+#if !defined(CONFIG_HUGETLB_PAGE) && !defined(CONFIG_CRASH_DUMP) \
+	&& !defined(CONFIG_CRASH_DUMP_MODULE)
 #define prep_compound_page(page, order) do { } while (0)
 #define destroy_compound_page(page, order) do { } while (0)
 #else
--- linux-2.6.0-test1/init/Makefile~lkcd-kernel-changes-2.6.0-test1	2003-07-13 21:33:12.000000000 -0600
+++ linux-2.6.0-test1-braam/init/Makefile	2003-07-22 00:52:14.000000000 -0600
@@ -9,6 +9,9 @@ mounts-$(CONFIG_BLK_DEV_RAM)	+= do_mount
 mounts-$(CONFIG_BLK_DEV_INITRD)	+= do_mounts_initrd.o
 mounts-$(CONFIG_BLK_DEV_MD)	+= do_mounts_md.o
 
+extra-$(CONFIG_CRASH_DUMP)	+= kerntypes.o
+CFLAGS_kerntypes.o		:= -gstabs
+
 # files to be removed upon make clean
 clean-files := ../include/linux/compile.h
 
@@ -24,3 +27,4 @@ $(obj)/version.o: include/linux/compile.
 include/linux/compile.h: FORCE
 	@echo '  CHK     $@'
 	@sh $(srctree)/scripts/mkcompile_h $@ "$(UTS_MACHINE)" "$(CONFIG_SMP)" "$(CC) $(CFLAGS)"
+
--- linux-2.6.0-test1/init/main.c~lkcd-kernel-changes-2.6.0-test1	2003-07-22 00:46:07.000000000 -0600
+++ linux-2.6.0-test1-braam/init/main.c	2003-07-22 00:52:14.000000000 -0600
@@ -100,6 +100,16 @@ extern void ipc_init(void);
 int system_running = 0;
 
 /*
+ * The kernel_magic value represents the address of _end, which allows
+ * namelist tools to "match" each other respectively.  That way a tool
+ * that looks at /dev/mem can verify that it is using the right System.map
+ * file -- if kernel_magic doesn't equal the namelist value of _end,
+ * something's wrong.
+ */
+extern unsigned long _end;
+unsigned long *kernel_magic = &_end;
+
+/*
  * Boot command-line arguments
  */
 #define MAX_INIT_ARGS 8
--- linux-2.6.0-test1/init/version.c~lkcd-kernel-changes-2.6.0-test1	2003-07-13 21:34:03.000000000 -0600
+++ linux-2.6.0-test1-braam/init/version.c	2003-07-22 00:52:14.000000000 -0600
@@ -10,6 +10,7 @@
 #include <linux/uts.h>
 #include <linux/utsname.h>
 #include <linux/version.h>
+#include <linux/stringify.h>
 
 #define version(a) Version_ ## a
 #define version_string(a) version(a)
@@ -28,3 +29,6 @@ struct new_utsname system_utsname = {
 const char *linux_banner = 
 	"Linux version " UTS_RELEASE " (" LINUX_COMPILE_BY "@"
 	LINUX_COMPILE_HOST ") (" LINUX_COMPILER ") " UTS_VERSION "\n";
+
+const char *LINUX_COMPILE_VERSION_ID = __stringify(LINUX_COMPILE_VERSION_ID);
+LINUX_COMPILE_VERSION_ID_TYPE;

_
