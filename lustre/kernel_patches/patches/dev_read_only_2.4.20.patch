Index: linux-2.4.20-8/drivers/block/blkpg.c
===================================================================
--- linux-2.4.20-8.orig/drivers/block/blkpg.c	2002-08-03 08:39:43.000000000 +0800
+++ linux-2.4.20-8/drivers/block/blkpg.c	2003-12-08 15:50:20.000000000 +0800
@@ -296,3 +296,42 @@
 }
 
 EXPORT_SYMBOL(blk_ioctl);
+
+  
+
+#define NUM_DEV_NO_WRITE 16
+static int dev_no_write[NUM_DEV_NO_WRITE];
+
+/*
+ * Debug code for turning block devices "read-only" (will discard writes
+ * silently).  This is for filesystem crash/recovery testing.
+ */
+void dev_set_rdonly(kdev_t dev, int no_write)
+{
+	if (dev) {
+		printk(KERN_WARNING "Turning device %s read-only\n",
+		       bdevname(dev));
+		dev_no_write[no_write] = 0xdead0000 + dev;
+	}
+}
+
+int dev_check_rdonly(kdev_t dev) {
+	int i;
+
+	for (i = 0; i < NUM_DEV_NO_WRITE; i++) {
+		if ((dev_no_write[i] & 0xffff0000) == 0xdead0000 &&
+		    dev == (dev_no_write[i] & 0xffff))
+			return 1;
+	}
+	return 0;
+}
+
+void dev_clear_rdonly(int no_write) {
+	dev_no_write[no_write] = 0;
+}
+
+EXPORT_SYMBOL(dev_set_rdonly);
+EXPORT_SYMBOL(dev_check_rdonly);
+EXPORT_SYMBOL(dev_clear_rdonly);
+
+
Index: linux-2.4.20-8/drivers/block/ll_rw_blk.c
===================================================================
--- linux-2.4.20-8.orig/drivers/block/ll_rw_blk.c	2003-12-08 15:47:50.000000000 +0800
+++ linux-2.4.20-8/drivers/block/ll_rw_blk.c	2003-12-08 15:51:17.000000000 +0800
@@ -1164,6 +1164,10 @@
 			buffer_IO_error(bh);
 			break;
 		}
+               if ((dev_check_rdonly(bh->b_rdev))&&(rw & WRITE)) {
+                        bh->b_end_io(bh, 0);
+                        break;
+                }
 	} while (q->make_request_fn(q, rw, bh));
 }
 
