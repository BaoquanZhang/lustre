 0 files changed

--- linux-2.4.20/fs/ext3/super.c~ext3-no-write-super	2003-08-11 13:20:17.000000000 +0400
+++ linux-2.4.20-alexey/fs/ext3/super.c	2003-08-11 13:31:35.000000000 +0400
@@ -1849,7 +1849,6 @@ void ext3_write_super (struct super_bloc
 	if (down_trylock(&sb->s_lock) == 0)
 		BUG();		/* aviro detector */
 	sb->s_dirt = 0;
-	target = log_start_commit(EXT3_SB(sb)->s_journal, NULL);
 
 	/*
 	 * Tricky --- if we are unmounting, the write really does need
@@ -1857,6 +1856,7 @@ void ext3_write_super (struct super_bloc
 	 * sb->s_root.
 	 */
 	if (do_sync_supers || !sb->s_root) {
+		target = log_start_commit(EXT3_SB(sb)->s_journal, NULL);
 		unlock_super(sb);
 		log_wait_commit(EXT3_SB(sb)->s_journal, target);
 		lock_super(sb);

_
