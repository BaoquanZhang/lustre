Index: linux-2.4.20-rh-20.9/include/linux/mm.h
===================================================================
--- linux-2.4.20-rh-20.9.orig/include/linux/mm.h	2003-11-13 17:35:48.000000000 +0300
+++ linux-2.4.20-rh-20.9/include/linux/mm.h	2003-11-17 15:50:22.000000000 +0300
@@ -713,6 +713,7 @@
 #define __GFP_IO	0x40	/* Can start low memory physical IO? */
 #define __GFP_HIGHIO	0x80	/* Can start high mem physical IO? */
 #define __GFP_FS	0x100	/* Can call down to low-level FS? */
+#define __GFP_MEMALLOC	0x200	/* like PF_MEMALLOC: see __alloc_pages */
 
 #define GFP_NOHIGHIO	(__GFP_HIGH | __GFP_WAIT | __GFP_IO)
 #define GFP_NOIO	(__GFP_HIGH | __GFP_WAIT)
@@ -723,6 +724,7 @@
 #define GFP_KERNEL	(__GFP_HIGH | __GFP_WAIT | __GFP_IO | __GFP_HIGHIO | __GFP_FS)
 #define GFP_NFS		(__GFP_HIGH | __GFP_WAIT | __GFP_IO | __GFP_HIGHIO | __GFP_FS)
 #define GFP_KSWAPD	(             __GFP_WAIT | __GFP_IO | __GFP_HIGHIO | __GFP_FS)
+#define GFP_MEMALLOC	__GFP_MEMALLOC
 
 /* Flag - indicates that the buffer will be suitable for DMA.  Ignored on some
    platforms, used as appropriate on others */
Index: linux-2.4.20-rh-20.9/mm/page_alloc.c
===================================================================
--- linux-2.4.20-rh-20.9.orig/mm/page_alloc.c	2003-11-13 17:20:37.000000000 +0300
+++ linux-2.4.20-rh-20.9/mm/page_alloc.c	2003-11-17 15:51:05.000000000 +0300
@@ -509,7 +509,8 @@
 	/*
 	 * Oh well, we didn't succeed.
 	 */
-	if (!(current->flags & (PF_MEMALLOC|PF_MEMDIE))) {
+	if (!(current->flags & (PF_MEMALLOC|PF_MEMDIE)) &&
+		!(gfp_mask & __GFP_MEMALLOC)) {
 		/*
 		 * Are we dealing with a higher order allocation?
 		 *
@@ -583,7 +583,9 @@
 
 		/* XXX: is pages_min/4 a good amount to reserve for this? */
 		min += z->pages_min / 4;
-		if (z->free_pages > min || ((current->flags & PF_MEMALLOC) && !in_interrupt())) {
+		if (z->free_pages > min ||
+		    (((current->flags & PF_MEMALLOC) || (gfp_mask & __GFP_MEMALLOC))
+		     && !in_interrupt())) {
 			page = rmqueue(z, order);
 			if (page)
 				return page;
Index: linux-2.4.20-rh-20.9/include/linux/slab.h
===================================================================
--- linux-2.4.20-rh-20.9.orig/include/linux/slab.h	2003-11-13 17:35:48.000000000 +0300
+++ linux-2.4.20-rh-20.9/include/linux/slab.h	2003-11-17 15:50:22.000000000 +0300
@@ -23,6 +23,7 @@
 #define	SLAB_KERNEL		GFP_KERNEL
 #define	SLAB_NFS		GFP_NFS
 #define	SLAB_DMA		GFP_DMA
+#define	SLAB_MEMALLOC		GFP_MEMALLOC
 
 #define SLAB_LEVEL_MASK		(__GFP_WAIT|__GFP_HIGH|__GFP_IO|__GFP_HIGHIO|__GFP_FS)
 #define	SLAB_NO_GROW		0x00001000UL	/* don't grow a cache */
Index: linux-2.4.20-rh-20.9/mm/slab.c
===================================================================
--- linux-2.4.20-rh-20.9.orig/mm/slab.c	2003-09-13 19:34:24.000000000 +0400
+++ linux-2.4.20-rh-20.9/mm/slab.c	2003-11-17 15:50:22.000000000 +0300
@@ -1116,7 +1116,7 @@
 	/* Be lazy and only check for valid flags here,
  	 * keeping it out of the critical path in kmem_cache_alloc().
 	 */
-	if (flags & ~(SLAB_DMA|SLAB_LEVEL_MASK|SLAB_NO_GROW))
+	if (flags & ~(SLAB_DMA|SLAB_LEVEL_MASK|SLAB_NO_GROW|SLAB_MEMALLOC))
 		BUG();
 	if (flags & SLAB_NO_GROW)
 		return 0;
