Name: kernel
Summary: The Linux Kernel
Version: @KERNEL_VERSION@
Release: @KERNEL_RELEASE@
License: GPL
Group: System Environment/Kernel
Vendor: Cluster File Systems, Inc.
URL: http://www.kernel.org/
Buildroot: /var/tmp/%{name}-%{PACKAGE_VERSION}-root

Source0: @LUSTRE_SOURCE@
Source1: @KERNEL_SOURCE@

%define __spec_install_post /usr/lib/rpm/brp-compress || :
%define debug_package %{nil}

%description
The Linux Kernel, the operating system core itself.

%package -n lustre-lite-utils
Summary: Lustre utils for Linux
Group: Applications/System

%description -n lustre-lite-utils
The Lustre Lite file system utilities.

#%package -n lustre-doc
#Summary: Sample Lustre configurations and documentation
#Group: Documentation

#%description -n lustre-doc
#The Lustre book, sample configurations, and other documentation for
#Lustre.

%package -n lustre-ldap
Summary: LDAP schema files for Lustre
Group: System Environment/Daemons

%description -n lustre-ldap
LDAP schema files for Lustre.

%prep
%setup -n lustre-kernel-%{version} -q -c
[ -d lustre ] || ln -sf lustre* lustre

%build
# if RPM_BUILD_NCPUS unset, set it
if [ -z "$RPM_BUILD_NCPUS" ] ; then
    RPM_BUILD_NCPUS=$(egrep -c "^cpu[0-9]+" /proc/stat || :)
    if [ $RPM_BUILD_NCPUS -eq 0 ] ; then
        RPM_BUILD_NCPUS=1
    fi
    if [ $RPM_BUILD_NCPUS -gt 8 ] ; then
        RPM_BUILD_NCPUS=8
    fi
fi

pushd lustre >/dev/null
./scripts/lmake \
	--phase build \
	--target @LUSTRE_TARGET@ \
	--extraversion %{release} \
	--kerneldir $RPM_SOURCE_DIR \
	-j $RPM_BUILD_NCPUS \
	-- @CONFIGURE_FLAGS@
popd >/dev/null

%install
rm -rf $RPM_BUILD_ROOT
mkdir -p $RPM_BUILD_ROOT
pushd lustre >/dev/null
./scripts/lmake \
	--phase install \
	--target @LUSTRE_TARGET@ \
	--extraversion %{release} \
	--destdir $RPM_BUILD_ROOT
popd >/dev/null

%clean
rm -rf $RPM_BUILD_ROOT

%files
%doc lustre/linux/COPYING lustre/linux/CREDITS lustre/linux/README
%doc lustre/linux/REPORTING-BUGS
%defattr(-, root, root)
%dir /lib/modules
/lib/modules/*
/boot/*

%files -n lustre-lite-utils
%doc lustre/COPYING lustre/BUGS lustre/ChangeLog lustre/README lustre/doc/lustre.pdf
%defattr(-, root, root)
%{_sbindir}/*
%{_bindir}/*
%{_libdir}/lustre/python
%{_sysconfdir}/init.d/lustre
/usr/include/lustre
/lib/lib*.a

#%files -n lustre-doc
#%defattr(-, root, root)
#/usr/share/doc/lustre/COPYING
#/usr/share/doc/lustre/lustre.pdf
#/usr/share/doc/lustre/COPYING

/usr/lib/lustre/examples

%files -n lustre-ldap
%defattr(-, root, root)
/etc/openldap/slapd-lustre.conf
/etc/openldap/schema/lustre.schema
/usr/lib/lustre/lustre2ldif.xsl
/usr/lib/lustre/top.ldif
