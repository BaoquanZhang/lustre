# obd.spec
%define version 0.3.2.0
%define kversion @RELEASE@
%define linuxdir @LINUX@
%define portalsdir @PORTALS@
Release: 0

Summary: Lustre Lite File System
Name: lustre-lite
Version: %{version}
Copyright: GPL
Group: Utilities/System
Requires: lustre-modules, perl-Storable, perl-Term-ReadLine-Gnu
BuildRoot: /var/tmp/obd-%{version}-root
Source: ftp://ftp.lustre.com/pub/lustre/obd-%{version}.tar.gz

%description
The Lustre Lite Cluster File System: kernel drivers for file system,
servers and utilities.

%package -n lustre-modules
Summary: Kernel Lustre drivers for Linux %{kversion}
Group: Development/Kernel

%description -n lustre-modules
Lustre file System, server and network drivers for Linux %{kversion}.

%package -n lustre-source
Summary: Object-Based Disk storage driver source
Group: Development/Kernel

%description -n lustre-source
Lustre Lite Source for further development

%prep
%setup -n obd-%{version}

%build
rm -rf $RPM_BUILD_ROOT

# Create the pristine source directory.
mkdir -p $RPM_BUILD_ROOT/usr/src/obd-%{version}
tar -cf - . | (cd $RPM_BUILD_ROOT/usr/src/obd-%{version} && tar -xvBpf -)
mkdir -p $RPM_BUILD_ROOT/tmp
echo :pserver:anonymous@cvs.lustre.sf.net:/cvsroot/lustre > $RPM_BUILD_ROOT/tmp/Root
(cd $RPM_BUILD_ROOT/usr/src/obd-%{version} && find . -name Root -exec cp $RPM_BUILD_ROOT/tmp/Root {} \; )

# Set an explicit path to our Linux tree, if we can.
./configure --enable-linuxdir=%{linuxdir} --enable-portalsdir=%{portalsdir}
make

%install
make install prefix=$RPM_BUILD_ROOT

%files
%attr(-, root, root) %doc COPYING FDL
%attr(-, root, root) %doc doc/API.txt doc/OBD-HOWTO.sgml doc/obdspec.sgml
%attr(-, root, root) %doc doc/OLVM.txt doc/figs doc/notes.txt
%attr(-, root, root) %doc doc/obdtrace_demo.txt
%attr(-, root, root) /usr/bin/obdctl

%files -n lustre-modules
%attr(-, root, root) %doc COPYING
%attr(-, root, root) /lib/modules/%{kversion}/fs/llight.o
%attr(-, root, root) /lib/modules/%{kversion}/fs/ptlrpc.o
%attr(-, root, root) /lib/modules/%{kversion}/fs/mds.o
%attr(-, root, root) /lib/modules/%{kversion}/fs/mdc.o
%attr(-, root, root) /lib/modules/%{kversion}/fs/ost.o
%attr(-, root, root) /lib/modules/%{kversion}/fs/osc.o
%attr(-, root, root) /lib/modules/%{kversion}/fs/obdclass.o
%attr(-, root, root) /lib/modules/%{kversion}/fs/obdfilter.o
%attr(-, root, root) /lib/modules/%{kversion}/fs/obdecho.o
%attr(-, root, root) /lib/modules/%{kversion}/fs/obdext2.o

%files -n lustre-source
%attr(-, root, root) /usr/src/obd-%{version}

%post
depmod -ae || exit 0

%postun
depmod -ae || exit 0

%clean
#rm -rf $RPM_BUILD_ROOT

# end of file
