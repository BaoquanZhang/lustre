# lustre.spec
%define version HEAD
%define kversion @RELEASE@
%define linuxdir @LINUX@
%define portalsdir @PORTALS@
%define portalslibdir @PORTALSLIB@
Release: 0301070810ltutor3

Summary: Lustre Lite File System
Name: lustre-lite
Version: %{version}
Copyright: GPL
Group: Utilities/System
Requires: lustre-modules, PyXML
BuildRoot: /var/tmp/lustre-%{version}-root
Source: ftp://ftp.lustre.com/pub/lustre/lustre-%{version}.tar.gz

%description
The Lustre Lite Cluster File System: kernel drivers for file system,
servers and utilities.

%package -n lustre-modules
Summary: Kernel Lustre drivers for Linux %{kversion}
Requires: portals-modules
Group: Development/Kernel

%description -n lustre-modules
Lustre file System, server and network drivers for Linux %{kversion}.

%package -n lustre-source
Summary: Object-Based Disk storage driver source
Group: Development/Kernel

%description -n lustre-source
Lustre Lite Source for further development

%package -n lustre-doc
Summary: Documentation and sample configuration files
Group: Documentation
# FIXME: BuildArch overrides all the packages in rpm 4.0.4-7x
#BuildArch: noarch

%description -n lustre-doc
Documentation and sample configuration files for Lustre

%package -n lustre-ldap
Summary: Configures openldap server for LDAP Lustre config database
Group: Configuration
Requires: openldap-servers, openldap-clients, python-ldap, 4Suite

%description -n lustre-ldap
Configures openldap server for LDAP Lustre config database

%prep
%setup -qn lustre-%{version}

%build
rm -rf $RPM_BUILD_ROOT

# Set an explicit path to our Linux tree, if we can.
./configure --with-linux='%{linuxdir}' --with-portals='%{portalsdir}' --with-portalslib='%{portalslibdir}'
make

%install
make install prefix=$RPM_BUILD_ROOT

# Create the pristine source directory.
mkdir -p $RPM_BUILD_ROOT/usr/src
rm -f lustre-source
ln -s $RPM_BUILD_ROOT/usr/src lustre-source
make distdir distdir=lustre-source/lustre-%{version}

# ldap database directory
mkdir -p $RPM_BUILD_ROOT/var/lib/ldap/lustre

%files
%attr(-, root, root) /usr/sbin/lmc
%attr(-, root, root) /usr/sbin/lctl
%attr(-, root, root) /usr/sbin/lconf
%attr(-, root, root) /usr/sbin/llanalyze
%attr(-, root, root) /usr/sbin/lfind
%attr(-, root, root) /usr/sbin/lstripe
%attr(-, root, root) /usr/sbin/mcreate
%attr(-, root, root) /usr/sbin/mkdirmany
%attr(-, root, root) /usr/lib/lustre/examples/llmount.sh
%attr(-, root, root) /usr/lib/lustre/examples/llmountcleanup.sh
%attr(-, root, root) /usr/lib/lustre/examples/llecho.sh
%attr(-, root, root) /usr/lib/lustre/examples/local.sh
%attr(-, root, root) /usr/lib/lustre/examples/uml.sh
%attr(-, root, root) /usr/lib/lustre/examples/lov.sh
%attr(-, root, root) /etc/init.d/lustre

%files -n lustre-doc
%attr(-, root, root) %doc COPYING FDL
%attr(-, root, root) %doc doc/lustre.pdf doc/lustre-HOWTO.txt
%attr(-, root, root) %doc tests/client-echo.cfg tests/client-mount.cfg
%attr(-, root, root) %doc tests/client-mount2.cfg
%attr(-, root, root) %doc tests/elan-client.cfg tests/elan-server.cfg
%attr(-, root, root) %doc tests/ldlm.cfg tests/lustre.cfg
%attr(-, root, root) %doc tests/mds.cfg tests/net-client.cfg
%attr(-, root, root) %doc tests/net-local.cfg tests/net-server.cfg
%attr(-, root, root) %doc tests/obdecho.cfg tests/obdfilter.cfg

%files -n lustre-modules
%attr(-, root, root) %doc COPYING
%attr(-, root, root) /lib/modules/%{kversion}/kernel/fs/lustre/extN.o
%attr(-, root, root) /lib/modules/%{kversion}/kernel/fs/lustre/ldlm.o
%attr(-, root, root) /lib/modules/%{kversion}/kernel/fs/lustre/llite.o
%attr(-, root, root) /lib/modules/%{kversion}/kernel/fs/lustre/mdc.o
%attr(-, root, root) /lib/modules/%{kversion}/kernel/fs/lustre/mds.o
%attr(-, root, root) /lib/modules/%{kversion}/kernel/fs/lustre/fsfilt_extN.o
%attr(-, root, root) /lib/modules/%{kversion}/kernel/fs/lustre/obdclass.o
%attr(-, root, root) /lib/modules/%{kversion}/kernel/fs/lustre/obdecho.o
%attr(-, root, root) /lib/modules/%{kversion}/kernel/fs/lustre/obdfilter.o
%attr(-, root, root) /lib/modules/%{kversion}/kernel/fs/lustre/lov.o
%attr(-, root, root) /lib/modules/%{kversion}/kernel/fs/lustre/osc.o
%attr(-, root, root) /lib/modules/%{kversion}/kernel/fs/lustre/ost.o
%attr(-, root, root) /lib/modules/%{kversion}/kernel/fs/lustre/ptlrpc.o

%files -n lustre-source
%attr(-, root, root) /usr/src/lustre-%{version}

%files -n lustre-ldap
%attr(-, root, root) /etc/openldap/slapd-lustre.conf
%attr(-, root, root) /etc/openldap/schema/lustre.schema
%attr(-, root, root) /usr/lib/lustre/lustre2ldif.xsl
%attr(-, root, root) /usr/lib/lustre/top.ldif
%dir /var/lib/ldap/lustre
%attr(700, ldap, ldap) /var/lib/ldap/lustre

%post
if [ ! -e /dev/obd ]; then
   mknod /dev/obd c 10 241
fi
depmod -ae || exit 0

grep -q obdclass /etc/modules.conf || \
	echo 'alias char-major-10-241 obdclass' >> /etc/modules.conf

grep -q '/dev/obd' /etc/modules.conf || \
	echo 'alias /dev/obd obdclass' >> /etc/modules.conf

grep -q '/dev/lustre' /etc/modules.conf || \
	echo 'alias /dev/lustre obdclass' >> /etc/modules.conf

%postun
depmod -ae || exit 0

%post -n lustre-ldap
if ! grep -q slapd-lustre /etc/openldap/slapd.conf; then 
  echo "include /etc/openldap/slapd-lustre.conf" >> /etc/openldap/slapd.conf
fi

%postun -n lustre-ldap
slapd=/etc/openldap/slapd.conf
if grep -q slapd-lustre $slapd; then 
   tmp=/tmp/lustre-ldap.$$
   sed "/slapd-lustre/d" $slapd >> $tmp
   cp $tmp $slapd
   rm $tmp
fi

%clean
#rm -rf $RPM_BUILD_ROOT

# end of file
