# lustre.spec
%define version 0.4.4
%define kversion @RELEASE@
%define linuxdir @LINUX@
%define portalsdir @PORTALS@
Release: 7

Summary: Lustre Lite File System
Name: lustre-lite
Version: %{version}
Copyright: GPL
Group: Utilities/System
Requires: lustre-modules, libxml2
BuildRoot: /var/tmp/lustre-%{version}-root
Source: ftp://ftp.lustre.com/pub/lustre/lustre-%{version}.tar.gz

%description
The Lustre Lite Cluster File System: kernel drivers for file system,
servers and utilities.

%package -n lustre-modules
Summary: Kernel Lustre drivers for Linux %{kversion}
Group: Development/Kernel

%description -n lustre-modules
Lustre file System, server and network drivers for Linux %{kversion}.

%package -n lustre-source
Summary: Object-Based Disk storage driver source
Group: Development/Kernel

%description -n lustre-source
Lustre Lite Source for further development

%prep
%setup -q -n lustre-%{version}

%build
rm -rf $RPM_BUILD_ROOT

# Set an explicit path to our Linux tree, if we can.
./configure --enable-linuxdir=%{linuxdir} --enable-portalsdir=%{portalsdir}
make

%install
make install prefix=$RPM_BUILD_ROOT
# Create the pristine source directory.

make distclean
mkdir -p $RPM_BUILD_ROOT/usr/src/lustre-%{version}
find . -print | cpio -ap  $RPM_BUILD_ROOT/usr/src/lustre-%{version}

%files
%attr(-, root, root) %doc COPYING FDL
%attr(-, root, root) %doc doc/master.pdf doc/lustre-HOWTO.txt
%attr(-, root, root) /usr/sbin/obdctl
%attr(-, root, root) /usr/sbin/llsetup.sh
%attr(-, root, root) /usr/sbin/llrsetup.sh
%attr(-, root, root) /usr/sbin/llcleanup.sh
%attr(-, root, root) /lib/lustre/common.sh
%attr(-, root, root) /etc/lustre/lustre.cfg

%files -n lustre-modules
%attr(-, root, root) %doc COPYING
%attr(-, root root) /lib/modules/%{kversion}/kernel/fs/extN.o
%attr(-, root root) /lib/modules/%{kversion}/kernel/fs/ldlm.o
%attr(-, root root) /lib/modules/%{kversion}/kernel/fs/llite.o
%attr(-, root root) /lib/modules/%{kversion}/kernel/fs/mdc.o
%attr(-, root root) /lib/modules/%{kversion}/kernel/fs/mds.o
%attr(-, root root) /lib/modules/%{kversion}/kernel/fs/mds_ext2.o
%attr(-, root root) /lib/modules/%{kversion}/kernel/fs/mds_ext3.o
%attr(-, root root) /lib/modules/%{kversion}/kernel/fs/mds_extN.o
%attr(-, root root) /lib/modules/%{kversion}/kernel/fs/obdclass.o
%attr(-, root root) /lib/modules/%{kversion}/kernel/fs/obdecho.o
%attr(-, root root) /lib/modules/%{kversion}/kernel/fs/obdfilter.o
%attr(-, root root) /lib/modules/%{kversion}/kernel/fs/obdfs.o
%attr(-, root root) /lib/modules/%{kversion}/kernel/fs/osc.o
%attr(-, root root) /lib/modules/%{kversion}/kernel/fs/ost.o
%attr(-, root root) /lib/modules/%{kversion}/kernel/fs/ptlrpc.o

%files -n lustre-source
%attr(-, root, root) /usr/src/lustre-%{version}

%post
if [ ! -e /dev/obd ]; then
   mknod /dev/obd c 10 241
fi

depmod -ae || exit 0

grep -q obdclass /etc/modules.conf || \
	echo 'alias char-major-10-241 obdclass' >> /etc/modules.conf

grep -q '/dev/obd' /etc/modules.conf || \
	echo 'alias /dev/obd obdclass' >> /etc/modules.conf

grep -q '/dev/lustre' /etc/modules.conf || \
	echo 'alias /dev/lustre obdclass' >> /etc/modules.conf


%postun
depmod -ae || exit 0

%clean
#rm -rf $RPM_BUILD_ROOT

# end of file
